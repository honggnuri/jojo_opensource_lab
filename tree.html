<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì¡°í˜•ëŒ€ ì†Œì›íŠ¸ë¦¬</title>
    <style>
        @font-face {
            font-family: 'DnfBitbeatV2';
            src: url('//cdn.df.nexon.com/img/common/font/DNFBitBitv2.otf') format('opentype');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'GangwonEducationSaeum';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2201-2@1.0/GangwonEduSaeeum_OTFMediumA.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        body {
            font-family: 'GangwonEducationSaeum', sans-serif;
            color: white;
            text-align: center;
            padding-top: 40px;
            margin: 0;

            background: url('./src/tree/BG_tree.png') no-repeat center top fixed;
            background-size: auto 100vh;

            height: 100vh;
            overflow: hidden; /* ì¤‘ìš”: ì œëª©ì€ ê³ ì •, ë°‘ë§Œ ìŠ¤í¬ë¡¤ */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-family: 'DnfBitbeatV2', sans-serif;
            margin-bottom: 10px;
            font-size: 60px;
            text-shadow: 0 0 10px rgba(21, 143, 15, 0.156),
                         0 0 20px rgba(21, 143, 15, 0.156);
        }

        /* íŠ¸ë¦¬ + ì¹´ë“œ ì˜ì—­ ì „ì²´ */
        #tree-container {
            width: 60%;
            height: 75vh; /* ì œëª© ì•„ë˜ë§Œ ìŠ¤í¬ë¡¤ */
            overflow: hidden; /* ë‚´ë¶€ì˜ wish-listë§Œ ìŠ¤í¬ë¡¤ */
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* ìœ„ì‹œ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
       #wish-list {
    display: flex;
    flex-direction: column;
    gap: 25px;

    width: 70%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;

    scroll-behavior: smooth;
    align-items: flex-start;
    padding-right: 15px;

    /* ğŸ”¥ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸°*/
    scrollbar-width: none; /* Firefox */
}
#wish-list::-webkit-scrollbar {
    display: none; /* Chrome / Safari */
}

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .wish-card {
            font-family: 'GangwonEducationSaeum', sans-serif;
            font-size: 38px;
            width: 100%;
            background: rgba(255, 255, 255, 0.13);
            padding: 8px 18px;
            animation: fadeIn 0.4s ease-out;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>

    <h1>ì¡°í˜•ëŒ€ ì†Œì›íŠ¸ë¦¬</h1>

    <div id="tree-container">
        <div id="wish-list"></div>
    </div>

   <script>
const WSS_URL = "wss://12spzvb7ok.execute-api.ap-southeast-2.amazonaws.com/production/";

let ws = null;
let reconnectTimeout = null;
let pingInterval = null;

// íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
let allWishes = JSON.parse(localStorage.getItem("wishHistory") || "[]");

const MAX_WISHES_DISPLAYED = 10;
const wishList = document.getElementById("wish-list");

// ì´ˆê¸° ë Œë”
function renderInitialWishes() {
    const recent = allWishes.slice(-MAX_WISHES_DISPLAYED);
    recent.forEach(text => {
        const div = document.createElement("div");
        div.className = "wish-card";
        div.textContent = text;
        wishList.appendChild(div);
    });
    wishList.scrollTop = wishList.scrollHeight;
}
renderInitialWishes();

/* ------------------------------------------------------
   ğŸ”¥ 1) ì›¹ì†Œì¼“ ìë™ ì—°ê²° í•¨ìˆ˜
------------------------------------------------------- */
function connect() {
    ws = new WebSocket(WSS_URL);

    ws.onopen = () => {
        console.log("ğŸ“¡ ì„œë²„ ì—°ê²° ì„±ê³µ! (tree)");

        // ì´ì „ reconnect íƒ€ì´ë¨¸ ì´ˆê¸°í™”
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        // ping(keepalive) ì‹œì‘
        pingInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: "ping" }));
                console.log("ğŸ’“ ping sent");
            }
        }, 30000);
    };

    ws.onmessage = (event) => {
    console.log("ğŸ“© ì„œë²„ ë©”ì‹œì§€:", event.data);

    try {
        // JSONë§Œ íŒŒì‹±í•˜ê¸°
        const data = JSON.parse(event.data);

        // ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” ì •ìƒ êµ¬ì¡°ë§Œ í™”ë©´ì— í‘œì‹œ
        if (data && typeof data === "object" && data.message) {
            addWish(data.message);
        }

    } catch (e) {
        // JSONì´ ì•„ë‹ˆë©´ (Forbidden ê°™ì€ í…ìŠ¤íŠ¸) ì™„ì „ ë¬´ì‹œ
        console.log("âš ï¸ JSON ì•„ë‹˜ â†’ ë¬´ì‹œë¨:", event.data);
        return;
    }
};

    ws.onerror = (e) => {
        console.log("ğŸ”¥ ì—ëŸ¬:", e);
    };

    ws.onclose = () => {
        console.log("âš ï¸ ì—°ê²° ëŠê¹€ â†’ 2ì´ˆ í›„ ì¬ì ‘ì†");

        // ping ë©ˆì¶”ê¸°
        clearInterval(pingInterval);

        // ìë™ ì¬ì ‘ì†
        reconnectTimeout = setTimeout(() => connect(), 2000);
    };
}

// ìµœì´ˆ ì‹¤í–‰
connect();

/* ------------------------------------------------------
   ğŸ”¥ 2) ìƒˆë¡œìš´ ì†Œì› ì¹´ë“œ ì¶”ê°€ í•¨ìˆ˜
------------------------------------------------------- */
function addWish(text) {
    allWishes.push(text);
    localStorage.setItem("wishHistory", JSON.stringify(allWishes));

    const div = document.createElement("div");
    div.className = "wish-card";
    div.textContent = text;
    wishList.appendChild(div);

    // ìë™ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    wishList.scrollTop = wishList.scrollHeight;

    // 10ê°œ ìœ ì§€
    if (wishList.children.length > MAX_WISHES_DISPLAYED) {
        wishList.removeChild(wishList.children[0]);
    }
}
</script>


</body>
</html>
