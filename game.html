<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Runner Game</title>

<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #222;
    }

    canvas {
        display: block;
        height: 100vh;
        width: auto;
        max-width: 100vw;
        margin: 0 auto;
        background: #333;
    }

    .ui-btn {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        padding: 14px 30px;
        background: #00c896;
        border: none;
        border-radius: 12px;
        color: #000;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        display: none;
        z-index: 99;
    }

    #restartBtn { top: 55%; }
    #clearBtn { 
        top: 65%;            /* ★ 게임클리어 버튼 위치 수정 */
        background:#ffe36e; 
    }
</style>
</head>
<body>

<!-- 버튼 -->
<button id="restartBtn" class="ui-btn">다시 시작</button>
<button id="clearBtn" class="ui-btn">종강이다!</button>

<canvas id="game" width="800" height="300"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let isMobile = ('ontouchstart' in window);

/* roundRect 구현 */
ctx.roundRect = function(x, y, w, h, r) {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    this.beginPath();
    this.moveTo(x + r, y);
    this.arcTo(x + w, y, x + w, y + h, r);
    this.arcTo(x + w, y + h, x, y + h, r);
    this.arcTo(x, y + h, x, y, r);
    this.arcTo(x, y, x + w, y, r);
    this.closePath();
};

/* 게임 상태 */
let gameState = "play";

/* 버튼 */
const restartBtn = document.getElementById("restartBtn");
const clearBtn = document.getElementById("clearBtn");

/* 이미지 fallback */
function drawImageAuto(img, x, y, w, h, fallbackColor) {
    if (img && img.complete && img.naturalWidth > 0) {
        ctx.drawImage(img, x, y, w, h);
    } else {
        ctx.fillStyle = fallbackColor;
        ctx.fillRect(x, y, w, h);
    }
}

let playerImg = new Image(); playerImg.src = "";
let obstacleImg = new Image(); obstacleImg.src = "";
let coffeeImg = new Image(); coffeeImg.src = "";
let bgImg = new Image(); bgImg.src = "";

/* 게임 요소 */
let player, bg, obstacles, coffees;
let frame, playerDistance, nextPatternDistance;

const obstacleTypes = [
    { width: 30, height: 40 },
    { width: 40, height: 30 },
    { width: 25, height: 45 }
];

const obstacleHeights = [260, 210];

/* 초기화 */
function initGame() {
    player = {
        x: 80,
        y: 200,
        width: 40,
        height: 40,
        vy: 0,
        gravity: 1.2,
        jumpPower: -16,
        jumpCount: 0,
        speed: isMobile ? 8 : 5,
        hp: 3
    };

    bg = { x: 0, width: 20000, height: 300 };
    obstacles = [];
    coffees = [];
    frame = 0;
    playerDistance = 0;
    nextPatternDistance = 500;
}

initGame();

/* 점프 */
function doJump() {
    if (gameState !== "play") return;
    if (player.jumpCount < 2) {
        player.vy = player.jumpPower;
        player.jumpCount++;
    }
}

if (isMobile) {
    canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        doJump();
    });
} else {
    canvas.addEventListener("mousedown", doJump);
}

/* 장애물 */
function spawnObstacle(offset = 0, h = "random") {
    const t = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    
    let yBase = h === "random"
        ? obstacleHeights[Math.floor(Math.random() * obstacleHeights.length)]
        : h;

    obstacles.push({
        x: canvas.width + offset + 50,
        y: yBase - t.height,
        width: t.width,
        height: t.height
    });
}

function spawnPattern() {
    const p = Math.floor(Math.random() * 4);

    if (p === 0) spawnObstacle(0, "random");
    if (p === 1) { spawnObstacle(0, 260); spawnObstacle(150, 260); }
    if (p === 2) spawnObstacle(0, 210);
    if (p === 3) { spawnObstacle(0, 260); spawnObstacle(200, 210); }

    nextPatternDistance = playerDistance + 450 + Math.random() * 300;
}

function spawnCoffee() {
    coffees.push({
        x: canvas.width + 50,
        y: 150,
        width: 25,
        height: 25
    });
}

/* 충돌 */
function collide(a, b) {
    return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
    );
}

/* update */
function updateGame() {
    if (gameState !== "play") return;

    bg.x -= player.speed;

    if (bg.x + bg.width <= canvas.width) {
        gameState = "clear";
        clearBtn.style.display = "block";
        return;
    }

    player.vy += player.gravity;
    player.y += player.vy;

    if (player.y >= 260 - player.height) {
        player.y = 260 - player.height;
        player.vy = 0;
        player.jumpCount = 0;
    }

    obstacles.forEach(o => o.x -= player.speed);
    coffees.forEach(c => c.x -= player.speed);

    obstacles = obstacles.filter(o => {
        if (collide(player, o)) {
            player.hp--;
            if (player.hp <= 0) {
                gameState = "over";
                restartBtn.style.display = "block";
            }
            return false;
        }
        return o.x + o.width > 0;
    });

    coffees = coffees.filter(c => {
        if (collide(player, c)) {
            if (player.hp < 3) player.hp++;
            return false;
        }
        return c.x + c.width > 0;
    });

    playerDistance += player.speed;

    if (playerDistance >= nextPatternDistance) spawnPattern();
    if (frame % 600 === 0) spawnCoffee();

    frame++;
}

/* UI */
function drawUI() {
    const progress = playerDistance / (bg.width - canvas.width);

    ctx.fillStyle = "#555";
    ctx.roundRect(250, 20, 300, 12, 6);
    ctx.fill();

    ctx.fillStyle = "#00FFAA";
    ctx.roundRect(250, 20, 300 * progress, 12, 6);
    ctx.fill();

    for (let i = 0; i < 3; i++) {
        drawImageAuto(
            coffeeImg,
            10 + i * 30,
            40,
            20,
            20,
            i < player.hp ? "#EBC15A" : "#555"
        );
    }
}

/* draw */
function drawGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawImageAuto(bgImg, bg.x, 0, bg.width, bg.height, "#444");

    ctx.fillStyle = "#666";
    ctx.fillRect(0, 260, canvas.width, 5);

    drawImageAuto(playerImg, player.x, player.y, player.width, player.height, "#4DB6FF");

    obstacles.forEach(o =>
        drawImageAuto(obstacleImg, o.x, o.y, o.width, o.height, "#FF5252")
    );

    coffees.forEach(c =>
        drawImageAuto(coffeeImg, c.x, c.y, c.width, c.height, "#EBC15A")
    );

    if (gameState === "play") drawUI();

    if (gameState === "over") {
        ctx.fillStyle = "red";
        ctx.font = "40px Arial";
        ctx.fillText("GAME OVER", 260, 150);
    }

    if (gameState === "clear") {
        ctx.fillStyle = "yellow";
        ctx.font = "40px Arial";
        ctx.fillText("GAME CLEAR!", 260, 120);   /* ★ 텍스트 위치 위로 이동 */
    }
}

/* loop */
function loop() {
    updateGame();
    drawGame();
    requestAnimationFrame(loop);
}
loop();

/* 버튼 이벤트 */
restartBtn.onclick = () => {
    location.href = "index.html";
};

clearBtn.onclick = () => {
    location.href = "wish.html";   /* ★ 종강이다 클릭 시 소원 페이지 이동 */
};
</script>

</body>
</html>
