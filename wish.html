<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì†Œì› ë¹Œê¸°</title>
<style>
    body {
        font-family: Arial;
        background: #f8f0ff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 60px;
    }
    h1 { margin-bottom: 30px; color: #5a2ea6; }
    textarea {
        width: 80%; height: 150px; padding: 15px; font-size: 18px;
        border-radius: 10px; border: 2px solid #c4a1ff; resize: none; outline: none;
    }
    button {
        margin-top: 25px; padding: 15px 40px; font-size: 18px;
        background: #7c4dff; color: white; border: none; border-radius: 10px;
        cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #6834ff; }
</style>
</head>
<body>

<h1>âœ¨ ì†Œì›ì„ ì ì–´ë³´ì„¸ìš” âœ¨</h1>
<textarea id="wishBox" placeholder="ì—¬ê¸°ì— ì†Œì›ì„ ì ìœ¼ì„¸ìš”..."></textarea>
<button onclick="sendWish()">ì†Œì› ë³´ë‚´ê¸°</button>

<script>
const WSS_URL = "wss://12spzvb7ok.execute-api.ap-southeast-2.amazonaws.com/production/";
let ws;
let pingInterval; // í•‘ì„ ë³´ë‚´ëŠ” íƒ€ì´ë¨¸ ë³€ìˆ˜

function connect() {
    ws = new WebSocket(WSS_URL);

    ws.onopen = () => {
        console.log("ğŸ“¡ ì„œë²„ ì—°ê²° ì„±ê³µ! (wish)");

        // â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¶€ë¶„] ì—°ê²° ìœ ì§€ìš© í•‘(Ping) ë³´ë‚´ê¸° â–¼â–¼â–¼
        // 30ì´ˆ(30000ms)ë§ˆë‹¤ ì„œë²„ì— ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
        pingInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                // AWS Lambda í˜•ì‹ì„ ë§ì¶°ì„œ 'ping'ì´ë¼ëŠ” ì•¡ì…˜ì„ ë³´ëƒ…ë‹ˆë‹¤.
                // (ë‹¨ìˆœ í…ìŠ¤íŠ¸ '.'ì„ ë³´ë‚´ë©´ ì„œë²„ ì„¤ì •ì— ë”°ë¼ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´ JSONìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤)
                const heartbeat = { action: "ping" }; 
                ws.send(JSON.stringify(heartbeat));
                console.log("ğŸ’“ ì—°ê²° ìœ ì§€ ì¤‘ (ping sent)");
            }
        }, 30000); 
    };

    ws.onerror = e => console.log("ğŸ”¥ ì—ëŸ¬:", e);

    // ì—°ê²°ì´ ëŠì–´ì§€ë©´ íƒ€ì´ë¨¸ë„ í•´ì œ
    ws.onclose = () => {
        console.log("ì—°ê²° ì¢…ë£Œ");
        clearInterval(pingInterval);
    };
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ì‹œì‘
connect();

function sendWish() {
    const wish = document.getElementById("wishBox").value.trim();
    if (wish.length === 0) {
        alert("ì†Œì›ì„ ì ì–´ì£¼ì„¸ìš”!");
        return;
    }

    const payload = {
        action: "sendWish",
        message: wish
    };

    // ì—°ê²°ì´ ëŠê²¨ìˆìœ¼ë©´ ë‹¤ì‹œ ì—°ê²° ì‹œë„ í›„ ë³´ë‚´ê¸° (ì•ˆì „ì¥ì¹˜)
    if (ws.readyState !== WebSocket.OPEN) {
        alert("ì„œë²„ì™€ ë‹¤ì‹œ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        connect();
        return;
    }

    ws.send(JSON.stringify(payload));

    alert("ğŸ‰ ì†Œì›ì„ ë³´ëƒˆì–´ìš”!");
    
    // íƒ€ì´ë¨¸ ì •ë¦¬ í›„ ì´ë™
    clearInterval(pingInterval);
    window.location.href = "index.html"; 
}
</script>
</body>
</html>